syntax = "proto3";

package pathfinding;
option csharp_namespace = "Pathfinding";

import "game.proto";

// Main request message - simplified
message PathfindingRequest {
    oneof payload {
        CalculatePathRequest path = 1;
        LineOfSightRequest los = 2;
        PhysicsInput step = 3;
        ReadyCheckRequest ready_check = 4;
        GetGroundZRequest ground_z = 5;
    }
}

// Main response message - simplified
message PathfindingResponse {
    oneof payload {
        CalculatePathResponse path = 1;
        LineOfSightResponse los = 2;
        PhysicsOutput step = 3;
        ReadyCheckResponse ready_status = 4;
        GetGroundZResponse ground_z = 5;
        Error error = 99;
    }
}

// Ready check - allows clients to query if the service is fully initialized
message ReadyCheckRequest {
    // Empty - just a ping to check status
}

message ReadyCheckResponse {
    bool is_ready = 1;                  // true when navigation data is loaded
    string status_message = 2;          // Human-readable status (e.g., "Loading maps...", "Ready")
    repeated uint32 loaded_maps = 3;    // List of map IDs that are currently loaded
}

// Error message
message Error {
    string message = 1;
}

// Path calculation
message CalculatePathRequest {
    uint32 map_id = 1;
    game.Position start = 2;
    game.Position end = 3;
    bool straight = 4;  // smooth path
}

message CalculatePathResponse {
    repeated game.Position corners = 1;
}

// Line of sight check
message LineOfSightRequest {
    uint32 map_id = 1;
    game.Position from = 2;
    game.Position to = 3;
}

message LineOfSightResponse {
    bool in_los = 1;
}

// Ground Z query
message GetGroundZRequest {
    uint32 map_id = 1;
    game.Position position = 2;
    float max_search_dist = 3;
}

message GetGroundZResponse {
    float ground_z = 1;
    bool found = 2;
}

// Dynamic object for physics collision (elevators, doors, trophy pillars)
message DynamicObjectProto {
    uint64 guid = 1;
    uint32 display_id = 2;
    float x = 3;
    float y = 4;
    float z = 5;
    float orientation = 6;
    float scale = 7;
    uint32 go_state = 8;
}

// Physics input
message PhysicsInput {
    // Movement state
    uint32 movement_flags = 1;
    
    // Position & orientation
    float pos_x = 2;
    float pos_y = 3;
    float pos_z = 4;
    float facing = 5;
    
    // Transport
    uint64 transport_guid = 6;
    float transport_offset_x = 7;
    float transport_offset_y = 8;
    float transport_offset_z = 9;
    float transport_orientation = 10;
    
    // Swimming/flying
    float swim_pitch = 11;
    
    // Falling/jumping
    float fall_time = 12;
    float fall_start_z = 39;  // Z when fall began (fed back from output)
    
    // Spline
    float spline_elevation = 13;
    
    // Current velocity
    float vel_x = 14;
    float vel_y = 15;
    float vel_z = 16;
    
    // Movement speeds
    float walk_speed = 17;
    float run_speed = 18;
    float run_back_speed = 19;
    float swim_speed = 20;
    float swim_back_speed = 21;
    
    // Collision
    uint32 race = 22;
    uint32 gender = 23;
    
    // Context
    uint32 map_id = 24;
    float delta_time = 25;

    uint32 frame_counter = 26;

	// Previous ground normal (from prior tick output)
	float prev_ground_z = 27;
	float prev_ground_nx = 28;
	float prev_ground_ny = 29;
	float prev_ground_nz = 30;

	// Pending depenetration vector (from prior tick output)
	float pending_depen_x = 31;
	float pending_depen_y = 32;
	float pending_depen_z = 33;

	// Standing-on (ride) reference
	uint32 standing_on_instance_id = 34;
	float standing_on_local_x = 35;
	float standing_on_local_y = 36;
	float standing_on_local_z = 37;

	// Behaviour flags (bitfield)
	// PHYSICS_FLAG_TRUST_INPUT_VELOCITY (0x1): Use input vx/vy as-is for airborne
	uint32 physics_flags = 38;

	// Nearby dynamic objects for collision (elevators, doors, trophy pillars)
	repeated DynamicObjectProto nearby_objects = 40;
}

// Physics output
message PhysicsOutput {
    // New position
    float new_pos_x = 1;
    float new_pos_y = 2;
    float new_pos_z = 3;
    
    // New velocity
    float new_vel_x = 4;
    float new_vel_y = 5;
    float new_vel_z = 6;
    
    // Updated state
    uint32 movement_flags = 7;
    float orientation = 8;
    float pitch = 9;
    
    // Status flags
    bool is_grounded = 10;
    bool is_swimming = 11;
    bool is_flying = 12;
    float fall_time = 13;
    
    // Spline progress (if following path)
    int32 current_spline_index = 14;
    float spline_progress = 15;

	// Ground surface details
	float ground_z = 16;
	float ground_nx = 17;
	float ground_ny = 18;
	float ground_nz = 19;
	float liquid_z = 20;
	uint32 liquid_type = 21;

	// Pending depenetration vector for next tick
	float pending_depen_x = 22;
	float pending_depen_y = 23;
	float pending_depen_z = 24;

	// Standing-on (ride) reference
	uint32 standing_on_instance_id = 25;
	float standing_on_local_x = 26;
	float standing_on_local_y = 27;
	float standing_on_local_z = 28;

	// Fall tracking
	float fall_distance = 29;   // Total Z drop on landing (positive = downward)
	float fall_start_z = 30;    // Z when current fall began
}