# PromptHandlingService

A .NET 8 Worker Service that provides AI/LLM prompt execution capabilities for the WWoW (Westworld of Warcraft) bot system. This service abstracts multiple AI provider backends (Azure AI, OpenAI, Ollama) and provides reusable prompt functions for bot decision-making.

## Overview

PromptHandlingService provides:
- **Multi-Provider Support**: Azure AI, OpenAI, Ollama, and a Fake provider for testing
- **Prompt Functions**: Reusable, composable AI prompt templates
- **Response Caching**: Reduces API calls for repeated queries
- **Intent Parsing**: Natural language to structured command conversion
- **GM Commands**: AI-assisted game master command construction

## Architecture

```
???????????????????????????????????????????????????????????????????????
?                     PromptHandlingService                            ?
?                                                                      ?
?  ?????????????????????????????????????????????????????????????????? ?
?  ?           PromptHandlingServiceWorker (BackgroundService)       ? ?
?  ?                      Main service host                          ? ?
?  ?????????????????????????????????????????????????????????????????? ?
?                                   ?                                  ?
?  ?????????????????????????????????????????????????????????????????? ?
?  ?                     PromptRunnerFactory                         ? ?
?  ?              Creates appropriate IPromptRunner instance         ? ?
?  ?????????????????????????????????????????????????????????????????? ?
?                                   ?                                  ?
?     ?????????????????????????????????????????????????????????????   ?
?     ?             ?               ?               ?             ?   ?
?  ?????????   ???????????   ????????????   ??????????????       ?   ?
?  ?Azure  ?   ? OpenAI  ?   ?  Ollama  ?   ?   Fake     ?       ?   ?
?  ?  AI   ?   ? Runner  ?   ?  Runner  ?   ?  Runner    ?       ?   ?
?  ?Runner ?   ?         ?   ?          ?   ? (Testing)  ?       ?   ?
?  ?????????   ???????????   ????????????   ??????????????       ?   ?
?                                                                      ?
?  ?????????????????????????????????????????????????????????????????? ?
?  ?                    Predefined Prompt Functions                  ? ?
?  ?  ????????????????  ????????????????  ????????????????         ? ?
?  ?  ?IntentParser  ?  ? GMCommand    ?  ? ConfigEditor ?         ? ?
?  ?  ?  Function    ?  ? Constructor  ?  ?   Function   ?         ? ?
?  ?  ????????????????  ????????????????  ????????????????         ? ?
?  ?  ????????????????                                              ? ?
?  ?  ?CharacterSkill?                                              ? ?
?  ?  ?Prioritization?                                              ? ?
?  ?  ????????????????                                              ? ?
?  ?????????????????????????????????????????????????????????????????? ?
?                                                                      ?
?  ?????????????????????????????????????????????????????????????????? ?
?  ?                       PromptCache                               ? ?
?  ?                Caches responses to reduce API calls             ? ?
?  ?????????????????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????????????????
```

## Project Structure

```
Services/PromptHandlingService/
??? PromptHandlingService.csproj        # .NET 8 Worker Service project
??? PromptHandlingServiceWorker.cs      # BackgroundService implementation
??? IPromptRunner.cs                    # Provider abstraction interface
??? IPromptFunction.cs                  # Prompt function interface
??? PromptFunctionBase.cs               # Base class for prompt functions
??? PromptRunnerFactory.cs              # Factory for creating runners
??? Providers/
?   ??? AzureAIPromptRunner.cs          # Azure AI endpoint integration
?   ??? OpenAIPromptRunner.cs           # OpenAI API integration
?   ??? OllamaPromptRunner.cs           # Local Ollama integration
?   ??? FakePromptRunner.cs             # Mock runner for testing
??? Predefined/
?   ??? IntentParser/
?   ?   ??? IntentionParserFunction.cs  # NL ? structured intent
?   ??? GMCommands/
?   ?   ??? GMCommandConstructionFunction.cs
?   ??? MaNGOSConfigHandlers/
?   ?   ??? ConfigEditorFunction.cs
?   ??? CharacterSkills/
?       ??? CharacterSkillPrioritizationFunction.cs
??? Cache/
?   ??? PromptCache.cs                  # Response caching
?   ??? Models/
?       ??? PreviousPrompts.cs          # Cache entry model
??? Utilities/
?   ??? StringParserUtilities.cs        # Response parsing helpers
??? README.md                           # This documentation
```

## Key Components

### IPromptRunner Interface

The core abstraction for AI providers:

```csharp
public interface IPromptRunner : IDisposable
{
    /// <summary>
    /// Runs a chat completion with the given history.
    /// </summary>
    /// <param name="chatHistory">Messages as role/content pairs</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>The assistant's response</returns>
    Task<string?> RunChatAsync(
        IEnumerable<KeyValuePair<string, string?>> chatHistory,
        CancellationToken cancellationToken);
    
    /// <summary>
    /// Maximum concurrent requests supported by this provider.
    /// </summary>
    int MaxConcurrent { get; }
}
```

### Prompt Providers

#### AzureAIPromptRunner

Connects to Azure AI endpoints (Azure OpenAI, Azure ML):

```csharp
var runner = new AzureAIPromptRunner(
    baseAddress: new Uri("https://your-endpoint.openai.azure.com/"),
    apiKey: "your-api-key"
);

var response = await runner.RunChatAsync(new[]
{
    KeyValuePair.Create("system", "You are a WoW bot assistant."),
    KeyValuePair.Create("user", "What spell should I cast next?")
}, cancellationToken);
```

#### OllamaPromptRunner

Connects to local Ollama instance for self-hosted models:

```csharp
var runner = new OllamaPromptRunner(
    baseAddress: new Uri("http://localhost:11434/"),
    modelName: "llama2"
);
```

#### FakePromptRunner

Returns predefined responses for testing without API calls:

```csharp
var runner = new FakePromptRunner();
// Returns mock responses for testing prompt functions
```

### Predefined Prompt Functions

#### IntentionParserFunction

Converts natural language commands into structured intents:

```csharp
// Input: "Go grind murlocs near Goldshire"
// Output: { Intent: "Grind", Target: "Murloc", Location: "Goldshire" }
```

#### GMCommandConstructionFunction

Generates MaNGOS GM commands from natural language:

```csharp
// Input: "Give me 100 gold"
// Output: ".modify money 1000000"
```

#### CharacterSkillPrioritizationFunction

Determines skill usage priority based on class and situation:

```csharp
// Input: Current game state (health, mana, targets, etc.)
// Output: Ordered list of skills to use
```

### PromptCache

Caches responses to reduce API calls for repeated queries:

```csharp
public class PromptCache
{
    public bool TryGetCachedResponse(string prompt, out string? response);
    public void CacheResponse(string prompt, string response);
}
```

## Configuration

Configure via `appsettings.json`:

```json
{
  "PromptHandling": {
    "Provider": "AzureAI",
    "AzureAI": {
      "Endpoint": "https://your-endpoint.openai.azure.com/",
      "ApiKey": "your-api-key",
      "DeploymentName": "gpt-4"
    },
    "OpenAI": {
      "ApiKey": "sk-your-key",
      "Model": "gpt-4"
    },
    "Ollama": {
      "BaseUrl": "http://localhost:11434/",
      "Model": "llama2"
    },
    "Cache": {
      "Enabled": true,
      "MaxEntries": 1000,
      "ExpirationMinutes": 60
    }
  }
}
```

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Microsoft.Extensions.Hosting | 8.0.0 | Worker service hosting |
| System.Text.Json | - | JSON serialization for API requests |

## Usage Examples

### Basic Chat Completion

```csharp
// Create runner
var runner = new AzureAIPromptRunner(endpoint, apiKey);

// Build chat history
var messages = new List<KeyValuePair<string, string?>>
{
    KeyValuePair.Create("system", "You are a WoW combat advisor."),
    KeyValuePair.Create("user", "I'm a level 30 warrior with low health, facing 2 murlocs. What should I do?")
};

// Get response
var response = await runner.RunChatAsync(messages, cancellationToken);
Console.WriteLine(response);
// Output: "Use Intimidating Shout to fear the murlocs, then bandage or use a health potion..."
```

### Using Prompt Functions

```csharp
// Create a prompt function
var intentParser = new IntentionParserFunction(runner);

// Parse user intent
var intent = await intentParser.ParseAsync("Go kill wolves in Elwynn Forest");
// Returns structured intent object

// Use with decision engine
var gmCommand = new GMCommandConstructionFunction(runner);
var command = await gmCommand.GenerateAsync("teleport me to Stormwind");
// Returns: ".tele Stormwind"
```

### With Caching

```csharp
var cache = new PromptCache();

// Check cache first
if (!cache.TryGetCachedResponse(prompt, out var response))
{
    response = await runner.RunChatAsync(messages, cancellationToken);
    cache.CacheResponse(prompt, response);
}
```

## Provider Comparison

| Provider | Latency | Cost | Offline | Best For |
|----------|---------|------|---------|----------|
| Azure AI | Low | $$$ | No | Production, enterprise |
| OpenAI | Low | $$$ | No | General use |
| Ollama | Medium | Free | Yes | Development, privacy |
| Fake | None | Free | Yes | Testing |

## Integration with Other Services

PromptHandlingService integrates with:

- **DecisionEngineService**: Provides AI-powered decision recommendations
- **BloogBot.AI**: Semantic Kernel integration for complex AI workflows
- **StateManager**: Can trigger state changes based on AI decisions

## Extending the Service

### Adding a New Provider

1. Create a class implementing `IPromptRunner`:

```csharp
public class MyCustomRunner : IPromptRunner
{
    public async Task<string?> RunChatAsync(
        IEnumerable<KeyValuePair<string, string?>> chatHistory,
        CancellationToken cancellationToken)
    {
        // Your implementation
    }
    
    public int MaxConcurrent => 10;
    
    public void Dispose() { }
}
```

2. Register in `PromptRunnerFactory`
3. Add configuration options

### Adding a New Prompt Function

1. Create a class extending `PromptFunctionBase`:

```csharp
public class MyPromptFunction : PromptFunctionBase
{
    public override string SystemPrompt => 
        "You are an expert at...";
    
    public async Task<MyResult> ExecuteAsync(string input)
    {
        var response = await RunAsync(input);
        return ParseResponse(response);
    }
}
```

## Error Handling

The service implements retry logic for transient failures:

```csharp
// Automatic retry up to 10 times
do
{
    try
    {
        var response = await client.PostAsync(...);
        if (response.IsSuccessStatusCode)
            return result;
    }
    catch (Exception e)
    {
        tryCount++;
    }
} while (tryCount < 10);
```

## Related Documentation

- See `BloogBot.AI/README.md` for Semantic Kernel integration
- See `Services/DecisionEngineService/README.md` for ML-based decisions
- See `ARCHITECTURE.md` for system overview

---

*This component is part of the WWoW (Westworld of Warcraft) simulation platform.*
