# Inter-Process Communication (IPC) Architecture

This document describes the TCP socket-based communication patterns used throughout the WWoW bot system. All services communicate using Protocol Buffers (protobuf) for efficient, type-safe message serialization.

## Overview

The system uses a client-server TCP socket architecture where:
- **Servers** listen for incoming connections and process requests
- **Clients** connect to servers and send/receive protobuf messages
- All messages are length-prefixed (4-byte integer) followed by serialized protobuf data

## BotCommLayer Infrastructure

The `BotCommLayer` project provides the foundational socket infrastructure:

### Base Classes

| Class | Type | Purpose |
|-------|------|---------|
| `ProtobufSocketServer<TRequest, TResponse>` | Server | Synchronous request/response server |
| `ProtobufAsyncSocketServer<T>` | Server | Async server with reactive streams |
| `ProtobufSocketClient<TRequest, TResponse>` | Client | Synchronous client for request/response |

### Message Protocol

All TCP communication follows this format:

```
?????????????????????????????????????????????????????
? Length (4 bytes) ? Protobuf Message (N bytes)     ?
?   Little-endian  ?   Serialized via ToByteArray() ?
?????????????????????????????????????????????????????
```

**Wire Protocol Flow:**
1. Client sends 4-byte message length
2. Client sends serialized protobuf message
3. Server reads length, then reads message bytes
4. Server deserializes, processes, creates response
5. Server sends 4-byte response length
6. Server sends serialized response
7. Client reads and deserializes response

---

## Communication Diagram

```
???????????????????????????????????????????????????????????????????????????????????????
?                              WWoW Bot System IPC Architecture                        ?
???????????????????????????????????????????????????????????????????????????????????????

                                    ???????????????????????
                                    ?    StateManager     ?
                                    ?      Service        ?
                                    ???????????????????????
                                               ?
                    ???????????????????????????????????????????????????????
                    ?                          ?                          ?
                    ?                          ?                          ?
     ????????????????????????????  ????????????????????????????  ????????????????????
     ? CharacterStateSocket     ?  ? StateManagerSocket       ?  ? MangosSOAP       ?
     ? Listener (Server)        ?  ? Listener (Server)        ?  ? Client           ?
     ? Port: config             ?  ? Port: config             ?  ? (HTTP/SOAP)      ?
     ? Proto: ActivitySnapshot  ?  ? Proto: AsyncRequest/     ?  ????????????????????
     ?        ?? ActivitySnapshot?  ?        StateChangeResponse?
     ????????????????????????????  ????????????????????????????
                    ?                          ?
                    ?                          ?
                    ?                          ?
     ???????????????????????????????          ?
     ?                             ?          ?
     ?                             ?          ?
???????????????????????            ?          ?
? BackgroundBotRunner ?            ?          ?
?     (Worker)        ??????????????          ?
???????????????????????                       ?
          ?                                   ?
          ?  ??????????????????????????????????
          ?  ?
          ?  ?
???????????????????????????????????????????????????????????????
?                    PathfindingService                        ?
?                        (Worker)                              ?
?  ?????????????????????????????????????????????????????????  ?
?  ? PathfindingSocketServer (Server)                      ?  ?
?  ? Port: config (default 5000)                           ?  ?
?  ? Proto: PathfindingRequest ?? PathfindingResponse      ?  ?
?  ?   • CalculatePathRequest/Response                     ?  ?
?  ?   • LineOfSightRequest/Response                       ?  ?
?  ?   • PhysicsInput/Output                               ?  ?
?  ?????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????
                    ?
                    ?
     ???????????????????????????????
     ?              ?              ?
     ?              ?              ?
???????????  ???????????????  ???????????????????
?WoWSharp ?  ? BotRunner   ?  ? Test Clients    ?
?Client   ?  ? Service     ?  ? (Unit Tests)    ?
???????????  ???????????????  ???????????????????


???????????????????????????????????????????????????????????????
?                  DecisionEngineService                       ?
?                       (Worker)                               ?
?  ?????????????????????????????????????????????????????????  ?
?  ? CombatModelServiceListener (Server)                   ?  ?
?  ? Port: 8080                                            ?  ?
?  ? Proto: ActivitySnapshot ?? ActivitySnapshot           ?  ?
?  ?????????????????????????????????????????????????????????  ?
?                           ?                                  ?
?                           ?                                  ?
?  ?????????????????????????????????????????????????????????  ?
?  ? CombatModelClient (Client)                            ?  ?
?  ? Connects to: external ML service                      ?  ?
?  ? Proto: ActivitySnapshot ?? ActivitySnapshot           ?  ?
?  ?????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????


???????????????????????????????????????????????????????????????
?                    Game Server Communication                 ?
?                 (WoWSharpClient - Not Protobuf)              ?
?  ?????????????????????????????????????????????????????????  ?
?  ? AuthLoginClient                                       ?  ?
?  ? Port: 3724 (Auth Server)                              ?  ?
?  ? Protocol: WoW 1.12.1 SRP6 Authentication              ?  ?
?  ?????????????????????????????????????????????????????????  ?
?  ?????????????????????????????????????????????????????????  ?
?  ? WorldClient                                           ?  ?
?  ? Port: 8085 (World Server)                             ?  ?
?  ? Protocol: WoW 1.12.1 World Protocol (RC4 encrypted)   ?  ?
?  ?????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????
```

---

## Service-by-Service Communication

### 1. PathfindingService

**Role:** Provides navigation, pathfinding, line-of-sight, and physics simulation.

#### Server: `PathfindingSocketServer`

| Property | Value |
|----------|-------|
| Base Class | `ProtobufSocketServer<PathfindingRequest, PathfindingResponse>` |
| Default Port | Configured via `PathfindingService:Port` |
| Request Type | `Pathfinding.PathfindingRequest` |
| Response Type | `Pathfinding.PathfindingResponse` |

**Supported Operations (via `oneof payload`):**

| Operation | Request | Response | Description |
|-----------|---------|----------|-------------|
| Path | `CalculatePathRequest` | `CalculatePathResponse` | A* pathfinding between two points |
| LoS | `LineOfSightRequest` | `LineOfSightResponse` | Check line-of-sight between points |
| Step | `PhysicsInput` | `PhysicsOutput` | Simulate one physics tick |

#### Clients That Connect

| Client Class | Project | Purpose |
|--------------|---------|---------|
| `PathfindingClient` | BotRunner | Bot navigation and movement |
| `InMemoryPathfindingClient` | Tests | Test mock (no network) |

**Example Usage:**
```csharp
var client = new PathfindingClient("127.0.0.1", 5000, logger);

// Calculate path
var path = client.GetPath(mapId: 0, start, end, smoothPath: true);

// Check line of sight
bool hasLos = client.IsInLineOfSight(mapId: 0, from, to);

// Physics step
var output = client.PhysicsStep(physicsInput);
```

---

### 2. StateManager Service

**Role:** Orchestrates bot instances, manages character state, and coordinates background workers.

#### Server: `CharacterStateSocketListener`

| Property | Value |
|----------|-------|
| Base Class | `ProtobufSocketServer<ActivitySnapshot, ActivitySnapshot>` |
| Port | Configured via `CharacterStateListener:Port` |
| Request/Response | `Communication.ActivitySnapshot` |

**Purpose:** Receives state updates from bot workers and returns the expected state for a given account.

**Request Handling:**
- If `AccountName == "?"`: Assigns the first unassigned character definition
- Otherwise: Returns the stored `ActivitySnapshot` for that account

#### Server: `StateManagerSocketListener`

| Property | Value |
|----------|-------|
| Base Class | `ProtobufAsyncSocketServer<StateChangeResponse>` |
| Port | Configured via `StateManagerListener:Port` |
| Request Type | `Communication.AsyncRequest` (wraps `StateChangeRequest`) |
| Response Type | `Communication.StateChangeResponse` |

**Purpose:** Handles async state change requests (commands to modify bot behavior).

#### Clients That Connect

| Client Class | Project | Purpose |
|--------------|---------|---------|
| `CharacterStateUpdateClient` | BotRunner | Send state updates to StateManager |
| `ActivityMemberUpdateClient` | StateManager | Internal state synchronization |
| `StateManagerUpdateClient` | StateManager | Send state change commands |

---

### 3. BackgroundBotRunner Service

**Role:** Headless bot execution using network client (WoWSharpClient).

#### Outbound Connections (Client)

| Client | Connects To | Purpose |
|--------|-------------|---------|
| `PathfindingClient` | PathfindingService | Navigation and physics |
| `CharacterStateUpdateClient` | StateManager | Report character state |
| `WoWClient` | Game Server | WoW protocol communication |

**Communication Flow:**
```
BackgroundBotRunner
    ?
    ???? PathfindingService (TCP/Protobuf)
    ?        ??? PathfindingRequest/Response
    ?
    ???? StateManager (TCP/Protobuf)
    ?        ??? ActivitySnapshot/ActivitySnapshot
    ?
    ???? Game Server (TCP/WoW Protocol)
             ??? AuthLoginClient (Port 3724)
             ??? WorldClient (Port 8085)
```

---

### 4. DecisionEngineService

**Role:** AI/ML-based decision making for combat and behavior.

#### Server: `CombatModelServiceListener`

| Property | Value |
|----------|-------|
| Base Class | `ProtobufSocketServer<ActivitySnapshot, ActivitySnapshot>` |
| Port | 8080 |
| Request/Response | `Communication.ActivitySnapshot` |

**Purpose:** Receives game state snapshots and returns AI-determined actions.

#### Client: `CombatModelClient`

| Property | Value |
|----------|-------|
| Base Class | `ProtobufSocketClient<ActivitySnapshot, ActivitySnapshot>` |
| Connects To | External ML service |

---

### 5. WoWSharpClient (Game Communication)

**Role:** Pure C# WoW 1.12.1 client implementation.

> **Note:** This uses the native WoW protocol, NOT protobuf.

#### AuthLoginClient

| Property | Value |
|----------|-------|
| Protocol | SRP6 Authentication |
| Port | 3724 |
| Encryption | None (challenge/proof exchange) |

**Flow:**
1. `CMD_AUTH_LOGON_CHALLENGE` ? Server
2. Server sends challenge (B, g, N, salt)
3. `CMD_AUTH_LOGON_PROOF` ? Server (client proof)
4. Server verifies and returns server proof
5. `CMD_REALM_LIST` ? Get available realms

#### WorldClient

| Property | Value |
|----------|-------|
| Protocol | WoW World Protocol |
| Port | 8085 (configurable) |
| Encryption | RC4 (Vanilla encryption) |

**Key Opcodes:**
- `CMSG_AUTH_SESSION` - Authenticate to world server
- `CMSG_CHAR_ENUM` - Request character list
- `CMSG_PLAYER_LOGIN` - Enter world with character
- `MSG_MOVE_*` - Movement packets
- `CMSG_MESSAGECHAT` - Send chat message

---

## Protobuf Message Definitions

All protobuf messages are defined in `Exports/BotCommLayer/Models/ProtoDef/`:

### pathfinding.proto

```protobuf
message PathfindingRequest {
    oneof payload {
        CalculatePathRequest path = 1;
        LineOfSightRequest los = 2;
        PhysicsInput step = 3;
    }
}

message PathfindingResponse {
    oneof payload {
        CalculatePathResponse path = 1;
        LineOfSightResponse los = 2;
        PhysicsOutput step = 3;
        Error error = 99;
    }
}
```

### communication.proto

```protobuf
message AsyncRequest {
    uint64 id = 1;
    oneof parameter {
        ActivitySnapshot activity_snapshot = 2;
        StateChangeRequest state_change = 3;
    }
}

message ActivitySnapshot {
    uint32 timestamp = 1;
    string accountName = 2;
    game.WoWPlayer player = 3;
    ActionMessage previousAction = 4;
    ActionMessage currentAction = 5;
    repeated game.WoWGameObject nearbyObjects = 6;
    repeated game.WoWUnit nearbyUnits = 7;
}

message StateChangeRequest {
    StateChangeType change_type = 1;
    RequestParameter request_parameter = 2;
}

message StateChangeResponse {
    ResponseResult response = 1;
}
```

---

## Configuration

### appsettings.json Example

```json
{
  "PathfindingService": {
    "IpAddress": "127.0.0.1",
    "Port": "5000"
  },
  "CharacterStateListener": {
    "IpAddress": "127.0.0.1",
    "Port": "5001"
  },
  "StateManagerListener": {
    "IpAddress": "127.0.0.1",
    "Port": "5002"
  },
  "RealmEndpoint": {
    "IpAddress": "127.0.0.1"
  }
}
```

---

## Client Implementation Pattern

All protobuf clients follow this pattern:

```csharp
public class MyClient : ProtobufSocketClient<TRequest, TResponse>
{
    public MyClient(string ipAddress, int port, ILogger logger)
        : base(ipAddress, port, logger) { }

    public TResponse DoSomething(SomeData data)
    {
        var request = new TRequest { /* build request */ };
        return SendMessage(request);  // Synchronous call
    }
}
```

---

## Server Implementation Pattern

All protobuf servers override `HandleRequest`:

```csharp
public class MyServer : ProtobufSocketServer<TRequest, TResponse>
{
    public MyServer(string ip, int port, ILogger logger)
        : base(ip, port, logger) { }

    protected override TResponse HandleRequest(TRequest request)
    {
        // Process request
        return new TResponse { /* build response */ };
    }
}
```

---

## Error Handling

### PathfindingService Errors

Errors are returned via the `Error` payload:

```csharp
return new PathfindingResponse
{
    Error = new Error { Message = "Description of error" }
};
```

Clients should check `PayloadCase`:

```csharp
var response = client.SendMessage(request);
if (response.PayloadCase == PathfindingResponse.PayloadOneofCase.Error)
    throw new Exception(response.Error.Message);
```

### Connection Errors

The base `ProtobufSocketClient` throws exceptions on:
- Connection failure
- Timeout (5 second default)
- Unexpected EOF

---

## Thread Safety

- `ProtobufSocketClient.SendMessage()` uses a lock for thread-safe access
- `ProtobufSocketServer` spawns a thread per client connection
- `ProtobufAsyncSocketServer` maintains a client dictionary keyed by request ID

---

## Regenerating Protobuf Code

When modifying `.proto` files, regenerate C# code:

```powershell
# From repository root
.\Exports\BotCommLayer\Models\ProtoDef\protocsharp.bat .\ .\.. "C:\path\to\protoc.exe"
```

See `Exports/BotCommLayer/README.md` for detailed instructions.

---

## Related Documentation

- [BotCommLayer README](Exports/BotCommLayer/README.md) - Protobuf definitions and generation
- [PathfindingService README](Services/PathfindingService/README.md) - Navigation service details
- [StateManager README](Services/StateManager/README.md) - State management architecture
- [ARCHITECTURE.md](ARCHITECTURE.md) - Overall system architecture
